<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Weekly Deals from Prox</title>
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-font-smoothing: antialiased; background-color: #F4FBF8; margin: 0; padding: 0;">

<div style="max-width: 600px; margin: 20px auto; background-color: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);">

    <!-- Header -->
    <div style="background-color: #0FB872; padding: 20px 30px; text-align: center; border-radius: 12px 12px 0 0;">
        <h1 style="color: #ffffff; font-size: 28px; margin: 0; font-weight: bold;">
            Prox Weekly Deals
        </h1>
    </div>

    <!-- Body Content -->
    <div style="padding: 30px;">
        <h2 style="font-size: 24px; color: #0A4D3C; margin: 0 0 15px;">Top Weekly Deals Just For You</h2>
        <p style="font-size: 16px; line-height: 1.6; color: #4a4a4a; margin-bottom: 25px;">
            Here are the top deals from your preferred retailers for this week. Happy shopping!
        </p>

        <!-- Personalized Deals Section -->
        <% if (deals.length > 0) { %>
        <%
        const dealsByRetailer = {};
        deals.forEach(deal => {
        const retailerName = deal.retailer.name;
        if (!dealsByRetailer[retailerName]) {
        dealsByRetailer[retailerName] = [];
        }
        dealsByRetailer[retailerName].push(deal);
        });
        %>
        <% for (const retailer in dealsByRetailer) { %>
        <div style="border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px; overflow: hidden;">
            <h3 style="background-color: #f7f7f7; color: #0A4D3C; padding: 12px 15px; margin: 0; font-size: 18px;">
                <%= retailer %>
            </h3>
            <% dealsByRetailer[retailer].forEach(deal => { %>
            <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span style="font-size: 16px; font-weight: bold; color: #0A4D3C;">
                                        <%= deal.product.name %>
                                    </span>
                    <span style="font-size: 16px; font-weight: bold; color: #0FB872;">
                                        $<%= deal.price.toFixed(2) %>
                                    </span>
                </div>
                <div style="font-size: 14px; color: #666666;">
                    <span>Size: <%= deal.product.size %></span><br>
                    <span style="font-size: 12px; color: #999999;">Valid: <%= new Date(deal.start_date).toLocaleDateString() %> - <%= new Date(deal.end_date).toLocaleDateString() %></span>
                </div>
            </div>
            <% }); %>
        </div>
        <% } %>
        <% } else { %>
        <p style="font-size: 16px; color: #666666; font-style: italic;">
            We're sorry, there are no deals available from your preferred retailers this week. Check back soon!
        </p>
        <% } %>

        <hr style="border: none; border-top: 1px solid #e0e0e0; margin: 30px 0;">

        <!-- All Deals Section -->
        <h2 style="font-size: 24px; color: #0A4D3C; margin: 0 0 15px;">Top 6 Deals Overall</h2>
        <p style="font-size: 16px; line-height: 1.6; color: #4a4a4a; margin-bottom: 25px;">
            Here are the top 6 deals from all available retailers, sorted by lowest price.
        </p>

        <% if (topDeals.length > 0) { %>
        <%
        const topDealsByRetailer = {};
        topDeals.forEach(deal => {
        const retailerName = deal.retailer.name;
        if (!topDealsByRetailer[retailerName]) {
        topDealsByRetailer[retailerName] = [];
        }
        topDealsByRetailer[retailerName].push(deal);
        });
        %>
        <% for (const retailer in topDealsByRetailer) { %>
        <div style="border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 20px; overflow: hidden;">
            <h3 style="background-color: #f7f7f7; color: #0A4D3C; padding: 12px 15px; margin: 0; font-size: 18px;">
                <%= retailer %>
            </h3>
            <% topDealsByRetailer[retailer].forEach(deal => { %>
            <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                                    <span style="font-size: 16px; font-weight: bold; color: #0A4D3C;">
                                        <%= deal.product.name %>
                                    </span>
                    <span style="font-size: 16px; font-weight: bold; color: #0FB872;">
                                        $<%= deal.price.toFixed(2) %>
                                    </span>
                </div>
                <div style="font-size: 14px; color: #666666;">
                    <span>Size: <%= deal.product.size %></span><br>
                    <span style="font-size: 12px; color: #999999;">Valid: <%= new Date(deal.start_date).toLocaleDateString() %> - <%= new Date(deal.end_date).toLocaleDateString() %></span>
                </div>
            </div>
            <% }); %>
        </div>
        <% } %>
        <% } %>
    </div>

    <!-- Footer -->
    <div style="background-color: #F4FBF8; padding: 20px 30px; text-align: center; border-radius: 0 0 12px 12px; border-top: 1px solid #e0e0e0;">
        <p style="font-size: 14px; color: #888888; margin: 0;">
            <a href="#" style="color: #0FB872; text-decoration: none; font-weight: bold;">Manage preferences</a>
        </p>
        <p style="font-size: 12px; color: #bbbbbb; margin-top: 10px;">
            You are receiving this email because you subscribed to Prox Weekly Deals.
        </p>
    </div>

</div>
</body>
</html>